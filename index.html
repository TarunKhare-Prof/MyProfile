<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tarun Khare – Portfolio</title>
  <link rel="stylesheet" href="style.css?v=1.0.4" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    /* Download button (top-right) */
    .download-btn {
      position: fixed;
      top: 14px;
      right: 14px;
      z-index: 2000;
      background: #2563eb;
      color: #fff;
      border: none;
      padding: 10px 14px;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,.2);
      font-weight: 600;
    }
    .download-btn:hover { background:#1e40af; }

    /* Hidden resume container for PDF rendering */
    #resumeRoot {
      position: fixed; 
      left: -99999px; 
      top: 0; 
      width: 794px;   /* A4 width at 96dpi ~ 794px */
      background: #fff;
      color: #111;
      font-family: "Segoe UI", system-ui, -apple-system, Roboto, Helvetica, Arial, sans-serif;
      line-height: 1.4;
    }
    .resume-doc { padding: 32px 40px; }
    .resume-header { display:flex; gap:16px; align-items:center; border-bottom:2px solid #e5e7eb; padding-bottom:12px; margin-bottom:10px; }
    .resume-header img { width:72px; height:72px; border-radius:50%; object-fit:cover; }
    .resume-header h1 { margin:0; font-size:22px; }
    .resume-header .sub { color:#374151; font-size:13px; margin-top:2px; }
    .resume-sec { margin-top:14px; }
    .resume-sec h2 { font-size:16px; margin:0 0 6px; color:#111827; }
    .resume-list { margin:0; padding-left:16px; font-size:12.5px; }
    .resume-list li { margin:4px 0; }
    .resume-p { margin:4px 0; font-size:12.5px; }
    .resume-project { margin:8px 0; }
    .resume-project .title { font-weight:600; font-size:13.5px; }
    .tags { margin-top:4px; display:flex; flex-wrap:wrap; gap:4px; }
    .tag { font-size:11.5px; padding:2px 6px; background:#eef2ff; color:#4338ca; border-radius:999px; }
    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .small { font-size:12px; color:#374151; }

    /* Page breaks for clean PDF */
    .page-break { page-break-before: always; }
    @media print {
      body { background:#fff; }
      .download-btn { display:none; }
    }
  </style>
</head>
<body>
  <button id="downloadResume" class="download-btn">⬇ Download Resume (PDF)</button>

  <header>
    <svg class="wave" viewBox="0 0 1440 90" preserveAspectRatio="none">
      <path d="M0,50 C400,140 1040,-40 1440,50 L1440,90 L0,90 Z"></path>
    </svg>
    <div class="header-content">
      <img src="images/profile.jpg" alt="Tarun Khare" class="profile-pic" />
      <div class="text-content">
        <h1>Tarun Khare</h1>
        <h2>Sr. Software Engineer</h2>
        <h3>At: Alstom Transport (Bangalore)</h3>
      </div>
    </div>
  </header>

  <nav id="tabs"></nav>
  <main id="tabWrapper"></main>

  <div id="lightbox" class="hidden">
    <span class="close">&times;</span>
    <div class="lightbox-content"></div>
  </div>

  <!-- Hidden resume DOM target -->
  <div id="resumeRoot"></div>

  <!-- PDF libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNa5lH9H5V2hHf1HqOu3cG7HqV2TnfJr1mQnQpS5t1N0qgxZr2m7wQ4iYl4m9BGb9vX2G8m9N1bC1xJcQx6Qvw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-/Fh7o4eW4kG4f7Q7xXbHcCk7wq9o1nN1i0tO9Jp6b7kz7Z7ZVq3B+0o7jXgmdqzYw0K2n8Hh5C7g1W+eQvGkTw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script>
    const fetchJSON = async (p) => (await fetch(p)).json();

    // --- helper: show active tab ---
    function showTab(id) {
      document.querySelectorAll('.tab-content')
              .forEach(el => el.classList.toggle('active', el.id === id));
    }

    // --- helper: lightbox ---
    function openLightbox(html) {
      const lb = document.getElementById('lightbox');
      const content = lb.querySelector('.lightbox-content');
      content.innerHTML = html;

      const video = content.querySelector('video');
      if (video) {
        video.setAttribute('autoplay', true);
        video.setAttribute('controls', true);
        video.setAttribute('playsinline', true);
        video.play().catch(err => console.log("Autoplay blocked:", err));
      }

      void content.offsetHeight;
      lb.style.display = 'flex';
      lb.classList.remove('hidden');
    }

    function closeLightbox() {
      const lb = document.getElementById('lightbox');
      const content = lb.querySelector('.lightbox-content');
      const video = content.querySelector('video');
      if (video) {
        video.pause();
        video.currentTime = 0;
      }
      content.innerHTML = '';
      lb.style.display = 'none';
      lb.classList.add('hidden');
    }

    // ============ renderer for Professional Projects ============
    function renderProfessionalProjects(container, contentArray) {
      if (!Array.isArray(contentArray)) {
        container.innerHTML += `<p class="note">No projects to display.</p>`;
        return;
      }
      if (!document.getElementById('proj-inline-style')) {
        const s = document.createElement('style');
        s.id = 'proj-inline-style';
        s.textContent = `
          .project-card{background:#fff;margin:16px 0;padding:20px;border-left:5px solid #2980b9;box-shadow:0 2px 6px rgba(0,0,0,.08);border-radius:10px}
          .project-card strong{display:block;font-size:18px;color:#2c3e50;margin-bottom:8px}
          .project-card p{margin:6px 0;line-height:1.5}
          .languages{margin-top:10px;font-size:14px;display:flex;flex-wrap:wrap;gap:6px}
          .language-tag{display:inline-block;background:#e8f0fe;color:#1a73e8;padding:4px 8px;border-radius:14px;line-height:1;white-space:nowrap}
          .note{color:#666;font-size:14px;margin-top:8px}
        `;
        document.head.appendChild(s);
      }
      const frag = document.createDocumentFragment();
      contentArray.forEach(entry => {
        const card = document.createElement('div');
        card.className = 'project-card';
        if (entry && typeof entry === 'object' && entry.description) {
          const langs = Array.isArray(entry.languages) ? entry.languages : [];
          card.innerHTML = `
            ${entry.description}
            ${langs.length ? `<div class="languages">${langs.map(l => `<span class="language-tag">${l}</span>`).join('')}</div>` : `<div class="note">Languages not specified.</div>`}
          `;
        } else if (typeof entry === 'string') {
          if (entry.includes('<strong>')) {
            const splitIndex = entry.indexOf('</strong>') + 9;
            const title = entry.slice(0, splitIndex);
            const desc = entry.slice(splitIndex).trim();
            card.innerHTML = `${title}<p>${desc}</p>`;
          } else {
            card.innerHTML = `<p>${entry}</p>`;
          }
        } else {
          card.innerHTML = `<p>${String(entry)}</p>`;
        }
        frag.appendChild(card);
      });
      container.appendChild(frag);
    }
    // ============================================================

    // -------- Build Resume DOM from data --------
    function buildResumeDOM(data, skillsData) {
      const root = document.getElementById('resumeRoot');
      root.innerHTML = ''; // clear
      const wrap = document.createElement('div');
      wrap.className = 'resume-doc';

      const profileImg = (data.profileImage || 'images/profile.jpg');

      // Header
      wrap.innerHTML += `
        <div class="resume-header">
          <img src="${profileImg}" alt="Profile">
          <div>
            <h1>Tarun Khare</h1>
            <div class="sub">Sr. Software Engineer &middot; Bengaluru, India</div>
            <div class="small">Portfolio: https://tarunkhare.in &nbsp; | &nbsp; LinkedIn: linkedin.com/in/tarun-khare-98ab5085</div>
            <div class="small">Email: tarun@tarunkhare.in &nbsp; | &nbsp; Phone: +91-8770057790</div>
          </div>
        </div>
      `;

      // Summary
      const summary = (data.tabs.find(t => t.id === 'summary') || {}).content || [];
      if (summary.length) {
        wrap.innerHTML += `<div class="resume-sec"><h2>Profile Summary</h2><ul class="resume-list">${
          summary.map(s => `<li>${s}</li>`).join('')
        }</ul></div>`;
      }

      // Experience
      const exp = (data.tabs.find(t => t.id === 'experience') || {}).content || [];
      if (exp.length) {
        wrap.innerHTML += `<div class="resume-sec"><h2>Work Experience</h2>${
          exp.map(p => `<p class="resume-p">${p}</p>`).join('')
        }</div>`;
      }

      // Professional Projects (with languages)
      const projTab = data.tabs.find(t => t.id === 'projects');
      if (projTab && Array.isArray(projTab.content)) {
        const section = document.createElement('div'); section.className='resume-sec';
        section.innerHTML = `<h2>Professional Projects</h2>`;
        projTab.content.forEach(e => {
          if (e && typeof e === 'object' && e.description) {
            const langs = Array.isArray(e.languages) ? e.languages : [];
            const div = document.createElement('div');
            div.className = 'resume-project';
            div.innerHTML = `
              <div class="title">${e.description.replace(/^<strong>|<\/strong>/g,'')}</div>
              ${langs.length ? `<div class="tags">${langs.map(l=>`<span class="tag">${l}</span>`).join('')}</div>` : ''}
            `;
            section.appendChild(div);
          } else if (typeof e === 'string') {
            const div = document.createElement('div');
            div.className = 'resume-project';
            div.innerHTML = `<div class="title">${e}</div>`;
            section.appendChild(div);
          }
        });
        wrap.appendChild(section);
      }

      // Personal Projects (text only)
      // Optional: load brief summaries from personal_projects.json if present in window._personalData
      if (window._personalData && Array.isArray(window._personalData)) {
        const pp = document.createElement('div'); pp.className='resume-sec';
        pp.innerHTML = `<h2>Personal Projects (Selected)</h2>`;
        window._personalData.slice(0,6).forEach(p=>{
          const d = p.description || {};
          const row = document.createElement('div');
          row.className = 'resume-project';
          row.innerHTML = `<div class="title">${p.title}</div><p class="resume-p small">${(d.about||'').toString()}</p>`;
          pp.appendChild(row);
        });
        wrap.appendChild(pp);
      }

      // Skills (flatten)
      if (Array.isArray(skillsData)) {
        const grid = document.createElement('div'); grid.className='resume-sec';
        grid.innerHTML = `<h2>Skills</h2>`;
        const byCat = skillsData.reduce((a,s)=>{(a[s.category]=a[s.category]||[]).push(s);return a;}, {});
        const cont = document.createElement('div'); cont.className='grid-2';
        Object.entries(byCat).forEach(([cat, list])=>{
          const col = document.createElement('div');
          col.innerHTML = `<div class="small" style="font-weight:700;margin-bottom:4px">${cat}</div>
                           <div class="tags">${list.map(x=>`<span class="tag">${x.name}</span>`).join('')}</div>`;
          cont.appendChild(col);
        });
        grid.appendChild(cont);
        wrap.appendChild(grid);
      }

      // Education
      const edu = (data.tabs.find(t => t.id === 'education') || {}).content || [];
      if (edu.length) {
        wrap.innerHTML += `<div class="resume-sec"><h2>Education</h2>${
          edu.map(p => `<p class="resume-p">${p}</p>`).join('')
        }</div>`;
      }

      // Contact
      const contact = (data.tabs.find(t => t.id === 'contact') || {}).content || [];
      if (contact.length) {
        wrap.innerHTML += `<div class="resume-sec"><h2>Contact</h2>${
          contact.map(p => `<p class="resume-p">${p}</p>`).join('')
        }</div>`;
      }

      root.appendChild(wrap);
      return root;
    }

    // -------- PDF Export --------
    async function exportResumePDF(rootEl) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'pt', 'a4');

      await doc.html(rootEl, {
        callback: function (doc) {
          doc.save('Tarun_Khare_Resume.pdf');
        },
        margin: [36, 36, 40, 36], // top, left, bottom, right (pts)
        autoPaging: 'text',
        x: 0,
        y: 0,
        html2canvas: { scale: 2, useCORS: true, backgroundColor: '#ffffff' }
      });
    }

    // media nav helpers (existing)
    function showPrev(index) {
      const items = document.querySelectorAll(`#project-${index} .media-item`);
      const current = [...items].findIndex(i => i.classList.contains('active'));
      if (current > 0) {
        items[current].classList.remove('active');
        items[current - 1].classList.add('active');
      }
    }
    function showNext(index) {
      const items = document.querySelectorAll(`#project-${index} .media-item`);
      const current = [...items].findIndex(i => i.classList.contains('active'));
      if (current < items.length - 1) {
        items[current].classList.remove('active');
        items[current + 1].classList.add('active');
      }
    }

    (async () => {
      const data = await fetchJSON('data/portfolio.json');
      const skillsData = await fetchJSON('data/skills.json');
      // Optional: personal projects for resume text
      try { window._personalData = await fetchJSON('data/personal_projects.json'); } catch(e){}

      const nav = document.getElementById('tabs');
      const wrap = document.getElementById('tabWrapper');

      // Expose for PDF build
      window._portfolioData = data;
      window._skillsData = skillsData;

      for (let i = 0; i < data.tabs.length; i++) {
        const tab = data.tabs[i];

        const btn = document.createElement('button');
        btn.innerHTML = `<i class="fa-regular fa-circle"></i> ${tab.label}`;
        btn.onclick = () => showTab(tab.id);
        nav.appendChild(btn);

        const sec = document.createElement('section');
        sec.className = 'tab-content' + (tab.id === 'skills' ? ' full-width' : '');
        sec.id = tab.id;

        if (tab.id !== 'skills') {
          sec.innerHTML = `<h2>${tab.title}</h2>`;
        }

        if (tab.id === 'personal') {
          const personalData = window._personalData || [];
          const grid = document.createElement('div');
          grid.className = 'projects-flex-list';

          grid.innerHTML = personalData.map((p, index) => {
            const mediaList = Array.isArray(p.src) ? p.src.map(m => m.url) : [];
            const desc = p.description || {};
            const mediaNav = mediaList.length > 1 ? `
              <button class="media-nav prev" onclick="showPrev(${index})">&#8592;</button>
              <button class="media-nav next" onclick="showNext(${index})">&#8594;</button>` : '';

            const mediaContent = mediaList.map((src, i) => {
              const ext = src.split('.').pop().toLowerCase();
              const mimeType =
                ext === 'mp4' ? 'video/mp4' :
                ext === 'webm' ? 'video/webm' :
                ext === 'ogg' ? 'video/ogg' : 'video/mp4';

              return (ext === 'mp4' || ext === 'webm' || ext === 'ogg')
                ? `<video preload="metadata" muted class="media-item ${i === 0 ? 'active' : ''}" onclick="openLightbox(this.outerHTML)">
                     <source src="${src}" type="${mimeType}">
                   </video>`
                : `<img src="${src}" class="media-item ${i === 0 ? 'active' : ''}" alt="${p.title}" onclick="openLightbox(this.outerHTML)">`;
            }).join('');

            return `
              <div class="project-row" id="project-${index}">
                <div class="media-column">
                  <div class="media-wrapper">
                    ${mediaContent}
                    ${mediaNav}
                  </div>
                </div>
                <div class="desc-column">
                  <h3>${p.title}</h3>
                  <p><strong>About:</strong> ${desc.about || ""}</p>
                  <p><strong>Software:</strong> ${desc.coding || ""}</p>
                  <p><strong>Hardware:</strong> ${desc.hardware || ""}</p>
                  <p><strong>Additional Info:</strong> ${desc.additional || ""}</p>
                </div>
              </div>
            `;
          }).join('');

          sec.appendChild(grid);

        } else if (tab.id === 'skills') {
          const table = document.createElement('table');
          table.className = 'skills-table';

          const grouped = skillsData.reduce((acc, skill) => {
            (acc[skill.category] = acc[skill.category] || []).push(skill);
            return acc;
          }, {});

          const levelOrder = { "Advanced": 5, "Working Level": 4, "Intermediate": 3, "Basic": 2, "Learning": 1 };

          let rows = '';
          Object.entries(grouped).forEach(([category, skills]) => {
            rows += `<tr class="category-row"><td colspan="5">${category}</td></tr>`;
            skills.sort((a, b) => (levelOrder[b.level] || 0) - (levelOrder[a.level] || 0)).forEach(skill => {
              const highlight = (skill.status || '').toLowerCase() === 'using' ? ' style="background-color:#eaffea"' : '';
              rows += `
                <tr${highlight}>
                  <td></td>
                  <td>${skill.name}</td>
                  <td>${skill.level}</td>
                  <td>${skill.status || ''}</td>
                </tr>`;
            });
          });

          table.innerHTML = `
            <thead>
              <tr>
                <th>Category</th>
                <th>Name</th>
                <th>Level</th>
                <th>Status / Last Used</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          `;

          const skillsWrapper = document.createElement('div');
          skillsWrapper.className = 'skills-wrapper';
          skillsWrapper.appendChild(table);
          sec.appendChild(skillsWrapper);

          const guideCard = document.createElement('div');
          guideCard.className = 'level-guide-card';
          guideCard.innerHTML = `
            <h3>Level Guide</h3>
            <table class="level-guide">
              <thead>
                <tr><th>Level</th><th>Label</th></tr>
              </thead>
              <tbody>
                <tr><td>5</td><td>Advanced</td></tr>
                <tr><td>4</td><td>Working Level</td></tr>
                <tr><td>3</td><td>Intermediate</td></tr>
                <tr><td>2</td><td>Basic</td></tr>
                <tr><td>1</td><td>Learning</td></tr>
              </tbody>
            </table>
          `;
          sec.appendChild(guideCard);

        } else if (tab.id === 'projects') {
          const holder = document.createElement('div');
          holder.id = 'projects-holder';
          sec.appendChild(holder);
          renderProfessionalProjects(holder, tab.content);

        } else if (tab.skillsGrouped) {
          Object.entries(tab.skillsGrouped).forEach(([category, skills]) => {
            const grid = document.createElement('div');
            grid.className = 'skills-grid';
            grid.innerHTML = `<h3>${category}</h3>` +
              skills.map(sk => `<div class="skill">${sk.name}</div>`).join('');
            sec.appendChild(grid);
          });

        } else if (tab.content) {
          sec.innerHTML += tab.content.map(t => `<p>${t}</p>`).join('');
        }

        wrap.appendChild(sec);
        if (i === 0) sec.classList.add('active');
      }

      document.getElementById('lightbox').addEventListener('click', (e) => {
        if (e.target.id === 'lightbox' || e.target.classList.contains('close')) {
          closeLightbox();
        }
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeLightbox();
        }
      });

      // Hook up Download button
      document.getElementById('downloadResume').addEventListener('click', async () => {
        const rootEl = buildResumeDOM(window._portfolioData, window._skillsData);
        await exportResumePDF(rootEl);
      });

    })();

    // Footer info
    document.getElementById('year').textContent = new Date().getFullYear();
    document.getElementById('lastModified').textContent = new Date(document.lastModified).toLocaleString();
  </script>

  <footer>
    <div class="footer-inner">
      <p>Made with 💻 by Tarun Khare &copy; <span id="year"></span></p>
      <p>Last Updated: <span id="lastModified"></span></p>
      <div class="social">
        <p>Connect On :</p>
        <a href="https://www.linkedin.com/in/tarun-khare-98ab5085/" aria-label="LinkedIn">
          <i class="fa-brands fa-linkedin"></i>
        </a>
      </div>
    </div>
  </footer>
</body>
</html>
